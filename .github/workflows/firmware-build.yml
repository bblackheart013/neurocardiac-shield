name: Firmware Build

on:
  push:
    branches: [ main ]
    paths:
      - 'firmware/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'firmware/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install GCC
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc

    - name: Compile firmware
      run: |
        gcc -o firmware/neurocardiac_fw \
            firmware/main.c \
            firmware/eeg/eeg_sim.c \
            firmware/ecg/ecg_sim.c \
            firmware/sensors/spo2_sim.c \
            firmware/sensors/temp_sim.c \
            firmware/sensors/accel_sim.c \
            firmware/communication/ble_stub.c \
            -lm -O2 -Wall -Wextra
        echo "Firmware compilation successful"

    - name: Verify executable
      run: |
        ls -la firmware/neurocardiac_fw
        file firmware/neurocardiac_fw

    - name: Test firmware execution (brief)
      run: |
        timeout 5 ./firmware/neurocardiac_fw || true
        echo "Firmware execution test completed"
